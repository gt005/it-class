{% extends 'tacks_education_system/tacks_education_system_base_template.html' %}
{% load static %}

{% block document_title %}Оценивание задач{% endblock %}

{% block main %}
    <section class="estimate-tasks__header">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h4 class="text-center" style="font-size: 40px;padding-bottom: 10px;">Оценивание задач</h4>
                </div>
            </div>
        </div>
    </section>
    <section class="estimate-tasks__change-languages pt-5">
        <div class="container">
            <div class="row">
                <div class="col-12 pb-2">
                    <h4>Изменить известные языки</h4>
                </div>
            </div>
            <div class="row">

                <div class="col">
                    <div id="estimate-tasks__change-languages__loader" class="d-none align-items-center justify-content-center"
                        style="position:absolute;height:100%;width:100%;background:rgba(255, 255, 255, 0.8);border-radius:0.4em;z-index:999;">
                        <div class="spinner-border text-info"
                            role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>

                    <div id="estimate-tasks__change-languages__buttons">
                        {% for lang in lang_list %}
                            {% if lang in user.puples.task_education_addition_data.languages %}
                                <button type="button" class="btn btn-outline-info my-1 active">{{lang}}</button>
                            {% else %}
                                <button type="button" class="btn btn-outline-info my-1">{{lang}}</button>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div id="estimate-tasks__change-languages__submit" class="mt-3">
                        {% csrf_token %}
                        <div class="invalid-feedback mb-1" id="estimate-tasks__change-languages__submit__empty-error-label">
                            Нужно отметить хотя бы 1 язык
                        </div>
                        <button id="estimate-tasks__change-languages__submit__button" type="button" class="btn btn-outline-success">Изменить</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block scripts_include %}
    <script>
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;


        $('#estimate-tasks__change-languages__buttons button').on('click', function () {
            this.classList.toggle('active');
        })

        $("#estimate-tasks__change-languages__submit__button").on('click', function () {

            let activeProgrammingLanguages = $('#estimate-tasks__change-languages__buttons button.active'),
                    enumerateActiveProgrammingLanguages = 0;

            if (activeProgrammingLanguages.length === 0) {
                $('#estimate-tasks__change-languages__submit__empty-error-label').fadeIn();
                return false;
            }

            $("#estimate-tasks__change-languages__loader").fadeIn();
            $('#estimate-tasks__change-languages__loader').removeClass('d-none');
            $('#estimate-tasks__change-languages__loader').addClass('d-flex');


            let data = new FormData();

            data.append("actionSetProgrammingLanguages", 'true');

            for (let index of activeProgrammingLanguages) {
                data.append("setProgrammingLanguage" + enumerateActiveProgrammingLanguages, activeProgrammingLanguages[enumerateActiveProgrammingLanguages].textContent);
                enumerateActiveProgrammingLanguages++;
            }

            fetch(location.origin + '/tasks/set_student_settings/', {
                method: 'POST',
                mode: 'same-origin',  // Do not send CSRF token to another domain.
                headers: {"X-CSRFToken": csrfToken},
                body: data
            }).then(function (response) {
                if (!response.ok) {
                    showAlertElement("Произошла ошибка, попробуйте перезагрузить страницу и попробовать снова.")
                    return false
                }

                return response.json();
            }).then(function (json) {
                console.log(json)
            if (json) {
                    $('#estimate-tasks__change-languages__loader').hide();
                    $('#estimate-tasks__change-languages__loader').addClass('d-none');
                    $('#estimate-tasks__change-languages__loader').removeClass('d-flex');
                    $('#estimate-tasks__change-languages__submit__empty-error-label').fadeOut();
                    showAlertElement("Языки успешно сохранены", success=true);
                }
            });

        })
    </script>
{% endblock %}

{% block detail_active_tasks_to_check %}active{% endblock %}