{% extends 'tacks_education_system/tacks_education_system_base_template.html' %}
{% load static %}

{% block document_title %}Оценивание задач{% endblock %}

{% block main %}
    <section class="estimate-tasks__header">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h4 class="text-center" style="font-size: 40px;padding-bottom: 10px;">Оценивание задач</h4>
                </div>
            </div>
        </div>
    </section>

    <section class="estimate-tasks__change-languages pt-5">
        <div class="container">
            <div class="row">
                <div class="col-12 pb-2 text-center text-md-left">
                    <h4>Изменить известные языки</h4>
                </div>
            </div>
            <div class="row">

                <div class="col d-flex d-md-block flex-column align-items-center">
                    <div id="estimate-tasks__change-languages__loader" class="d-none align-items-center justify-content-center"
                        style="position:absolute;height:100%;width:100%;background:rgba(255, 255, 255, 0.8);border-radius:0.4em;z-index:999;">
                        <div class="spinner-border text-info"
                            role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>

                    <div id="estimate-tasks__change-languages__buttons">
                        {% for lang in lang_list %}
                            {% if lang in user.puples.task_education_addition_data.known_languages %}
                                <button type="button" class="btn btn-outline-info my-1 active">{{lang}}</button>
                            {% else %}
                                <button type="button" class="btn btn-outline-info my-1">{{lang}}</button>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <div id="estimate-tasks__change-languages__submit" class="mt-3">
                        {% csrf_token %}
                        <div class="invalid-feedback mb-1" id="estimate-tasks__change-languages__submit__empty-error-label">
                            Нужно отметить хотя бы 1 язык
                        </div>
                        <button id="estimate-tasks__change-languages__submit__button" type="button" class="btn btn-outline-success">Изменить</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

     <section class="estimate-tasks__tasks-section" style="padding-top: 55px">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h4 class="text-center" style="font-size: 40px;padding-bottom: 10px;">На оценивании</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    {% for estimated_task in estimated_tasks %}
                        {% if estimated_task.first_peer_mark is None and estimated_task.first_peer == user.puples or estimated_task.second_peer_mark is None and estimated_task.second_peer == user.puples %}
                        <button data-toggle="modal"
                                data-task-name="{{ estimated_task.original_task.task_name }}"
                                data-task-id="{{ estimated_task.id }}"
                                data-student-name="{{ estimated_task.solved_user.surname }} {{ estimated_task.solved_user.name }}"
                                data-target="#setEstimateScoreModal"
                                class="task-list-page__container task-list-page__active-container estimate-tasks__tasks-section__task"
                                style="pointer-events: auto; cursor: pointer">
                            <div class="task-list-page__container__theme-name">
                                <span>Задача на тему: “{{ estimated_task.original_task.task_level.level_theme }}”</span>
                                <br>
                                <span>"{{ estimated_task.original_task.task_name }}"</span>
                                <br>
                                <span>Уровень: {{ estimated_task.original_task.task_level.level_number }}</span>
                                <br>
                                <span>Решивший ученик: {{ estimated_task.solved_user.surname }} {{ estimated_task.solved_user.name }}</span>
                            </div>

                            <span class="estimate-tasks__tasks-section__task__background__level-number">
                                 <span>{{ estimated_task.original_task.task_level.level_number }}</span>
                             </span>

                        </button>
                        {% endif %}
                    {% endfor %}


                    <div class="estimate-tasks__tasks-section__estimated-tasks">
                    {% for estimated_task in estimated_tasks %}
                        {% if estimated_task.first_peer_mark is not None and estimated_task.first_peer == user.puples or estimated_task.second_peer_mark is not None and estimated_task.second_peer == user.puples %}
                            <a class="task-list-page__container task-list-page__active-container">
                            <div class="task-list-page__container__theme-name">
                                <span>Задача на тему: “{{ estimated_task.original_task.task_level.level_theme }}”</span>
                                <br>
                                <span>"{{ estimated_task.original_task.task_name }}"</span>
                                <br>
                                <span>Уровень: {{ estimated_task.original_task.task_level.level_number }}</span>
                                <br>
                                <span>Решивший ученик: {{ estimated_task.solved_user.surname }} {{ estimated_task.solved_user.name }}</span>
                            </div>
                            <table class="table table-borderless task-list-page__container__table">
                                <thead>
                                    <tr>
                                        <th scope="col">Твоя оценка</th>
                                        <th scope="col">Оценка второго пира</th>
                                        <th scope="col">Оценка системы</th>
                                        <th scope="col">Результат</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr>
                                        {% if estimated_task.first_peer == user.puples %}
                                            <td>
                                                {{ estimated_task.first_peer_mark }}
                                            </td>
                                        {% elif estimated_task.second_peer == user.puples %}
                                            <td>
                                                {{ estimated_task.second_peer_mark }}
                                            </td>
                                        {% endif %}

                                        {% if estimated_task.first_peer != user.puples %}
                                            {% if estimated_task.first_peer_mark %}
                                                <td>
                                                    {{ estimated_task.first_peer_mark }}
                                                </td>
                                            {% else %}
                                                <td>-</td>
                                            {% endif %}
                                        {% else %}
                                            {% if estimated_task.second_peer_mark %}
                                                <td>
                                                    {{ estimated_task.second_peer_mark }}
                                                </td>
                                            {% else %}
                                                <td>-</td>
                                            {% endif %}
                                        {% endif %}

                                        <td>
                                            {% if estimated_task.system_mark %}
                                                {{ estimated_task.system_mark }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>

                                        <td>
                                            {% if estimated_task.result_summ_mark %}
                                                {{ estimated_task.result_summ_mark }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>

                            </table>
                        </a>
                        {% endif %}
                    {% empty %}
                         <h3 class="text-center">Нет задач на оценивание</h3>
                    {% endfor %}
                    </div>

                </div>
            </div>
        </div>
    </section>

{% endblock %}

{% block modal_windows %}

    <div class="modal fade" id="setEstimateScoreModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header" style="border: none">
            <h5 class="modal-title" id="exampleModalLabel">Отправить оценку</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body" style="min-height: 150px">
              <form method="post" id="estimate-modal-form" class="position-relative">
                  {% csrf_token %}
                  <input type="hidden" name="task_id" value="">

                  <div class="estimate-modal-form__input-form">
                      <label for="estimate-modal-form__input-number" class="estimate-modal-form__input-label">
                      <span class="estimate-modal-form__input-number__header">
                          Введите оценку задачи
                      </span>
                      <br>
                      <span id="estimate-modal-form__input-label__task-name"></span>
                      <br>
                      <span id="estimate-modal-form__input-label__student-name"></span>
                      </label>
                    <input type="number" name="task_score" id="estimate-modal-form__input-number" class="form-control" min="0" max="100" value="0">
                  </div>

                  <div class="estimate-modal-form__submit-page position-absolute">
                      <h3 class="pb-3">Оценку больше нельзя будет изменить</h3>
                      <div class="estimate-modal-form__submit-page__label"></div>
                      <button type="button" class="btn btn-outline-danger estimate-modal-form__submit-page__dismiss-submit-button">Отмена</button>
                      <input type="submit" class="estimate-modal-form__submit-page__submit-button btn btn-outline-success" value="Отправить">
                  </div>
              </form>
          </div>
          <div class="modal-footer" style="border: 0">
              <div id="estimate-modal__footer-buttons">
                  <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Отмена</button>
                  <button type="button" class="btn btn-outline-success estimate-modal__submit-page-button">Отправить</button>
              </div>
          </div>
        </div>
      </div>
    </div>

{% endblock %}

{% block scripts_include %}
    <script>

        if (navigator.userAgent.toLowerCase().indexOf("safari") !== -1) {
            document.querySelectorAll(".estimate-tasks__tasks-section__task.task-list-page__container").forEach(function () {
                this.style = "linear-gradient(135deg,#fff 36%,rgba(0,255,0,.38) 91%)!important";
            })
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        let estimateInput = document.querySelector("#estimate-modal-form__input-number"),
            estimateForm = document.querySelector("#estimate-modal-form"),
            estimateFormNextPageButton = document.querySelector(".estimate-modal__submit-page-button"),
            estimateFormTaskIdInput = document.querySelector("#estimate-modal-form input[name=\"task_id\"]");


        $('#estimate-tasks__change-languages__buttons button').on('click', function () {
            this.classList.toggle('active');
        })

        $("#estimate-tasks__change-languages__submit__button").on('click', function () {

            let activeProgrammingLanguages = $('#estimate-tasks__change-languages__buttons button.active'),
                    enumerateActiveProgrammingLanguages = 0;

            if (activeProgrammingLanguages.length === 0) {
                $('#estimate-tasks__change-languages__submit__empty-error-label').fadeIn();
                return false;
            }

            $("#estimate-tasks__change-languages__loader").fadeIn();
            $('#estimate-tasks__change-languages__loader').removeClass('d-none');
            $('#estimate-tasks__change-languages__loader').addClass('d-flex');


            let data = new FormData();

            data.append("actionSetProgrammingLanguages", 'true');

            for (let index of activeProgrammingLanguages) {
                data.append("setProgrammingLanguage" + enumerateActiveProgrammingLanguages, activeProgrammingLanguages[enumerateActiveProgrammingLanguages].textContent);
                enumerateActiveProgrammingLanguages++;
            }

            fetch(location.origin + '/tasks/set_student_settings/', {
                method: 'POST',
                mode: 'same-origin',  // Do not send CSRF token to another domain.
                headers: {"X-CSRFToken": csrfToken},
                body: data
            }).then(function (response) {
                if (!response.ok) {
                    showAlertElement("Произошла ошибка, попробуйте перезагрузить страницу и попробовать снова.")
                    return false
                }

                return response.json();
            }).then(function (json) {
                console.log(json)
            if (json) {
                    $('#estimate-tasks__change-languages__loader').hide();
                    $('#estimate-tasks__change-languages__loader').addClass('d-none');
                    $('#estimate-tasks__change-languages__loader').removeClass('d-flex');
                    $('#estimate-tasks__change-languages__submit__empty-error-label').fadeOut();
                    showAlertElement("Набор языков успешно сохранён", success=true);
                }
            });

        })

        $(".estimate-tasks__tasks-section__task").on('click', function () {
            document.querySelector("#estimate-modal-form__input-label__task-name").textContent = 'Задача: "' + this.dataset.taskName + '"';
            document.querySelector("#estimate-modal-form__input-label__student-name").textContent = "Ученик: " + this.dataset.studentName;
            estimateFormTaskIdInput.value = this.dataset.taskId;
            estimateInput.value = 0;
            $("#estimate-modal__footer-buttons").fadeIn();
            $(".estimate-modal-form__input-form").fadeIn();
            $(".estimate-modal-form__submit-page").fadeOut("fast");
        })
{}
        $(".estimate-modal-form__submit-page__dismiss-submit-button").on("click", function () {
            $("#estimate-modal__footer-buttons").fadeIn();
            $(".estimate-modal-form__input-form").fadeIn();
            $(".estimate-modal-form__submit-page").fadeOut("fast")
        })

        estimateForm.addEventListener('keydown', function(event) {
            if(event.keyCode == 13) {
                event.preventDefault();
            }
        });

        estimateInput.onchange = function () {
            if (this.value > 100) {
                this.value = 100;
            } else if (this.value < 0) {
                this.value = 0;
            }
        }

        estimateFormNextPageButton.onclick = function () {
            $(".estimate-modal-form__input-form").fadeOut("fast");
            $("#estimate-modal__footer-buttons").fadeOut("fast");
            $(".estimate-modal-form__submit-page").fadeIn();
        }

    </script>
{% endblock %}

{% block detail_active_tasks_to_check %}active{% endblock %}